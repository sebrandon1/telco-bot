name: TLS 1.3 Compliance Check - Weekly

on:
  schedule:
    # Run weekly on Sundays at 10:00 AM UTC
    - cron: '0 10 * * 0'
  workflow_dispatch:

jobs:
  tls-compliance-check:
    runs-on: ubuntu-latest
    env:
      SHELL: /bin/bash

    steps:
      - name: Install the JQ package
        run: sudo apt-get install jq -y

      - name: Clone the telco-bot repository
        uses: actions/checkout@v6

      - name: Check if TLS13_CHECKER_GITHUB_TOKEN secret exists
        run: |
          if [ -z "${{ secrets.TLS13_CHECKER_GITHUB_TOKEN }}" ]; then
            echo "Warning: TLS13_CHECKER_GITHUB_TOKEN secret is not set."
            echo "Using default GITHUB_TOKEN instead."
          fi

      - name: Login to gh cli tool
        run: |
          if [ -n "${{ secrets.TLS13_CHECKER_GITHUB_TOKEN }}" ]; then
            echo "$TLS13_GITHUB_TOKEN" | gh auth login --with-token
          else
            echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          fi
        env:
          TLS13_GITHUB_TOKEN: ${{ secrets.TLS13_CHECKER_GITHUB_TOKEN }}

      - name: Run the TLS 1.3 compliance checker script
        run: |
          echo "Running TLS 1.3 compliance checker (weekly scan)"
          echo "Using API mode - no repository cloning needed"
          ./scripts/tls13-compliance-checker.sh --mode api

      - name: Upload compliance report as artifact
        uses: actions/upload-artifact@v6
        with:
          name: tls-compliance-report
          path: tls13-compliance-report.md
          retention-days: 30
